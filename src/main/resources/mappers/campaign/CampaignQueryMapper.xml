<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="be15fintomatokatchupbe.campaign.query.mapper.CampaignQueryMapper">
    <resultMap id="InfluencerInfoMap" type="be15fintomatokatchupbe.campaign.query.dto.response.InfluencerInfo">
        <id property="influencerId" column="influencerId"/>
        <result property="name" column="influencerName"/>

        <association property="youtube" javaType="be15fintomatokatchupbe.campaign.query.dto.response.InfluencerInfo$Youtube">
            <result property="name" column="youtubeName"/>
            <result property="thumbnailUrl" column="youtubeThumbnailUrl"/>
        </association>

        <association property="instagram" javaType="be15fintomatokatchupbe.campaign.query.dto.response.InfluencerInfo$Instagram">
            <result property="name" column="instagramName"/>
        </association>
    </resultMap>

    <select id="findCampaignWithCategory"
            resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.CampaignWithCategoryDTO">
        SELECT
        c.client_company_id AS clientCompanyId,
        cc.client_company_name AS clientCompanyName,
        c.campaign_id AS campaignId,
        c.campaign_name AS campaignName,
        c.campaign_status_id AS campaignStatusId,
        c.product_name AS productName
        FROM campaign c
        JOIN client_company cc ON c.client_company_id = cc.client_company_id
        JOIN hashtag_influencer_campaign hic ON c.campaign_id = hic.campaign_id
        <where>
            c.is_deleted = 'N'
            AND c.campaign_status_id IN (2, 3)

            <if test="clientCompanyId != null">
                AND c.client_company_id = #{clientCompanyId}
            </if>

            <if test="campaignName != null and campaignName != ''">
                AND c.campaign_name LIKE CONCAT('%', #{campaignName}, '%')
            </if>

            <if test="tags != null and tags.size > 0">
                AND hic.category_id IN
                <foreach item="tag" collection="tags" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            </if>
        </where>
        GROUP BY c.campaign_id
        LIMIT 100 OFFSET 0
    </select>

    <select id="findCategoryByCampaignId" resultType="be15fintomatokatchupbe.influencer.query.dto.response.CategoryDto">
        SELECT
              c.category_id AS categoryId
            , c.category_name AS categoryName
        FROM
            hashtag_influencer_campaign hic
        JOIN
            category c ON c.category_id = hic.category_id
        WHERE
            hic.campaign_id = #{campaignId}
    </select>


    <select id="findPipelineList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ProposalCardDTO">
        SELECT
        p.pipeline_id AS pipelineId,
        p.name AS name,
        c.campaign_id AS campaignId,
        c.campaign_name AS campaignName,
        ps.pipeline_status_id AS statusId,
        ps.status_name AS statusName,
        cc.client_company_id AS clientCompanyId,
        cc.client_company_name AS clientCompanyName,
        cm.client_manager_id AS clientManagerId,
        cm.name AS clientManagerName,
        DATE_FORMAT(p.request_at, '%Y-%m-%d') AS requestAt,
        DATE_FORMAT(p.presented_at, '%Y-%m-%d') AS presentAt,
        GROUP_CONCAT(u.name SEPARATOR ', ') AS userNameInfo
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
        client_manager cm ON cm.client_manager_id = picm.client_manager_id
        LEFT JOIN
        pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        LEFT JOIN
        user u ON pu.user_id = u.user_id
        JOIN
        pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id

        WHERE
        p.pipeline_step_id = #{ pipelineStepId }
        AND
        p.is_deleted = 'N'

        <!-- 검색 조건 추가하기 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'user'">
                AND cm.name LIKE concat('%', #{req.keyword}, '%')
            </if>
        </if>
        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>
        <if test="req.filter != null">
            AND p.pipeline_status_id = #{req.filter}
        </if>

        GROUP BY
        p.pipeline_id, p.name, ps.status_name, cc.client_company_name, c.product_name, p.expected_revenue, cm.name

        ORDER BY
        <choose>
            <when test="req.sort == 'date'">p.created_at</when>
            <when test="req.sort == 'title'">p.name</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        <choose>
            <when test="req.sortOrder == 'desc'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findListupList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ListupCardDTO">
        SELECT
        p.pipeline_id AS pipelineId,
        p.name AS name,
        u.name AS userName,
        c.campaign_name AS campaignName,
        cc.client_company_name AS clientCompanyName,
        c.product_name AS productName,
        GROUP_CONCAT(i.name SEPARATOR ', ') AS influencerNameInfo
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.influencer_id IS NOT NULL
<!--        LEFT JOIN-->
        LEFT JOIN
        pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        LEFT JOIN
        user u ON p.writer_id = u.user_id
        LEFT JOIN
        influencer i ON picm.influencer_id = i.influencer_id

        WHERE
        p.pipeline_step_id = #{ pipelineStepId }
        AND
        p.is_deleted = 'N'
        <!-- 인플루언서는 조회하지 않음! -->

        <!-- 검색 조건 추가하기 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
        </if>
        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>

        GROUP BY
        p.pipeline_id, p.name, c.campaign_name, cc.client_company_name, c.product_name, u.name

        ORDER BY
        <choose>
            <when test="req.sort == 'date'">p.created_at</when>
            <when test="req.sort == 'title'">p.name</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        <choose>
            <when test="req.sortOrder == 'desc'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findQuotationList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.QuotationCardDTO">
        SELECT
            p.pipeline_id AS pipelineId,
            p.name AS name,
            ps.status_name AS statusName,
            cc.client_company_name AS clientCompanyName,
            cm.name AS clientManagerName,
            c.product_name AS productName,
            p.expected_revenue AS expectedRevenue,
            GROUP_CONCAT(u.name SEPARATOR ', ') AS userNameInfo
        FROM
            pipeline p
        JOIN
            campaign c ON p.campaign_id = c.campaign_id
        JOIN
            client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
            pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
            client_manager cm ON cm.client_manager_id = picm.client_manager_id
        LEFT JOIN
            pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        LEFT JOIN
            user u ON pu.user_id = u.user_id
        JOIN
            pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id

        WHERE
            p.pipeline_step_id = #{ pipelineStepId }
        AND
            p.is_deleted = 'N'
        <!-- 인플루언서는 조회하지 않음! -->

        <!-- 검색 조건 추가하기 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'user'">
                AND cm.name LIKE concat('%', #{req.keyword}, '%')
            </if>
        </if>
        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>
        <if test="req.filter != null">
            AND p.pipeline_status_id = #{req.filter}
        </if>

        GROUP BY
            p.pipeline_id, p.name, ps.status_name, cc.client_company_name, c.product_name, p.expected_revenue, cm.name

        ORDER BY
        <choose>
            <when test="req.sort == 'date'">p.created_at</when>
            <when test="req.sort == 'title'">p.name</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        <choose>
            <when test="req.sortOrder == 'desc'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findContractList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ContractCardDTO">
        SELECT
        p.pipeline_id AS pipelineId,
        p.name AS name,
        ps.status_name AS statusName,
        cc.client_company_name AS clientCompanyName,
        cm.name AS clientManagerName,
        c.product_name AS productName,
        p.expected_revenue AS expectedRevenue,
        GROUP_CONCAT(u.name SEPARATOR ', ') AS userNameInfo
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
        client_manager cm ON cm.client_manager_id = picm.client_manager_id
        LEFT JOIN
        pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        LEFT JOIN
        user u ON pu.user_id = u.user_id
        JOIN
        pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id

        WHERE
        p.pipeline_step_id = #{ pipelineStepId }
        AND
        p.is_deleted = 'N'
        <!-- 인플루언서는 조회하지 않음! -->

        <!-- 검색 조건 추가하기 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'user'">
                AND cm.name LIKE concat('%', #{req.keyword}, '%')
            </if>
        </if>
        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>
        <if test="req.filter != null">
            AND p.pipeline_status_id = #{req.filter}
        </if>

        GROUP BY
        p.pipeline_id, p.name, ps.status_name, cc.client_company_name, c.product_name, p.expected_revenue, cm.name

        ORDER BY
        <choose>
            <when test="req.sort == 'date'">p.created_at</when>
            <when test="req.sort == 'title'">p.name</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        <choose>
            <when test="req.sortOrder == 'desc'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="findRevenueList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.RevenueCardDTO">
        SELECT
        p.pipeline_id AS pipelineId,
        p.name AS name,
        ps.status_name AS statusName,
        cc.client_company_name AS clientCompanyName,
        cm.name AS clientManagerName,
        c.product_name AS productName,
        GROUP_CONCAT(u.name SEPARATOR ', ') AS userNameInfo
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
        client_manager cm ON cm.client_manager_id = picm.client_manager_id
        LEFT JOIN
        pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        LEFT JOIN
        user u ON pu.user_id = u.user_id
        JOIN
        pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id

        WHERE
        p.pipeline_step_id = #{ pipelineStepId }
        AND
        p.is_deleted = 'N'
        <!-- 인플루언서는 조회하지 않음! -->

        <!-- 검색 조건 추가하기 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'user'">
                AND cm.name LIKE concat('%', #{req.keyword}, '%')
            </if>
        </if>
        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>
        <if test="req.filter != null">
            AND p.pipeline_status_id = #{req.filter}
        </if>

        GROUP BY
        p.pipeline_id, p.name, ps.status_name, cc.client_company_name, c.product_name, p.expected_revenue, cm.name

        ORDER BY
        <choose>
            <when test="req.sort == 'date'">p.created_at</when>
            <when test="req.sort == 'title'">p.name</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        <choose>
            <when test="req.sortOrder == 'desc'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findTotalAdPrice" resultType="Long">
        SELECT
            SUM(ad_price) AS totalAdPrice
        FROM
            pipeline_influencer_client_manager
        WHERE
            influencer_id IS NOT NULL
        AND
            ad_price IS NOT NULL;
    </select>

    <select id="countListup" resultType="int">
        SELECT COUNT(DISTINCT p.pipeline_id)
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.influencer_id IS NOT NULL
        LEFT JOIN
        user u ON p.writer_id = u.user_id
        LEFT JOIN
        influencer i ON picm.influencer_id = i.influencer_id

        WHERE
        p.pipeline_step_id = #{pipelineStepId}
        AND p.is_deleted = 'N'

        <!-- 검색 조건 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
        </if>

        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>
    </select>

    <select id="countPipeline" resultType="int">
        SELECT
        COUNT(DISTINCT p.pipeline_id)
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
        client_manager cm ON cm.client_manager_id = picm.client_manager_id
        LEFT JOIN
        pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        LEFT JOIN
        user u ON pu.user_id = u.user_id
        JOIN
        pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id
        WHERE
        p.pipeline_step_id = #{pipelineStepId}
        AND p.is_deleted = 'N'

        <!-- 검색 조건 동일하게 복붙 -->
        <if test="req.keyword != null and req.keyword != ''">
            <if test="req.category == 'title'">
                AND p.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'clientCompany'">
                AND cc.client_company_name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.category == 'user'">
                AND cm.name LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
        </if>
        <if test="req.userId != null">
            AND u.user_id = #{req.userId}
        </if>
        <if test="req.filter != null">
            AND p.pipeline_status_id = #{req.filter}
        </if>
    </select>

<!-- 요기부터 detail -->
    <select id="findListupDetail" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ListupFormDTO">
        SELECT
              c.campaign_id AS campaignId
            , c.campaign_name AS campaignName
            , p.name AS name
            , cc.client_company_id AS clientCompanyId
            , cc.client_company_name AS clientCompanyName
        FROM
            pipeline p
        JOIN
            campaign c ON p.campaign_id = c.campaign_id
        JOIN
            client_company cc ON cc.client_company_id = c.client_company_id
        WHERE
            p.pipeline_step_id = #{pipelineStepId}
        AND
            p.pipeline_id = #{pipelineId}
        AND
            p.is_deleted = 'N'
    </select>

    <select id="findProposalDetail" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ProposalFormDTO">
        SELECT
        p.name AS name
        , cc.client_company_id AS clientCompanyId
        , cc.client_company_name AS clientCompanyName
        , cm.client_manager_id AS clientManagerId
        , cm.name AS clientManagerName
        , c.campaign_id AS campaignId
        , c.campaign_name AS campaignName
        , ps.pipeline_status_id AS pipelineStatusId
        , ps.status_name AS pipelineStatusName
        , p.request_at AS requestAt
        , p.presented_at AS presentAt
        , p.started_at AS startedAt
        , p.ended_at
        , p.notes AS notes
        , p.content AS content
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
        client_manager cm ON cm.client_manager_id = picm.client_manager_id

        WHERE
        p.is_deleted = 'N'
        AND
        p.pipeline_id = #{pipelineId}
<!--        AND-->
<!--        p.pipeline_step_id = #{pipelineStepId}-->
    </select>

    <select id="findQuotationDetail" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.QuotationFormDTO">
        SELECT
            p.name AS name
            , cc.client_company_id AS clientCompanyId
            , cc.client_company_name AS clientCompanyName
            , cm.client_manager_id AS clientManagerId
            , cm.name AS clientManagerName
            , c.campaign_id AS campaignId
            , c.campaign_name AS campaignName
            , ps.pipeline_status_id AS pipelineStatusId
            , ps.status_name AS pipelineStatusName
            , p.request_at AS requestAt
            , p.presented_at AS presentAt
            , p.started_at AS startedAt
            , p.ended_at
            , p.notes AS notes
            , p.content AS content
            , p.expected_revenue AS expectedRevenue
            , p.available_quantity AS availableQuantity
            , p.expected_profit AS expectedProfit
        FROM
            pipeline p
        JOIN
            campaign c ON p.campaign_id = c.campaign_id
        JOIN
            pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id
        JOIN
            client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
            pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
            client_manager cm ON cm.client_manager_id = picm.client_manager_id

        WHERE
            p.is_deleted = 'N'
        AND
            p.pipeline_id = #{pipelineId}
        AND
            p.pipeline_step_id = #{pipelineStepId}
    </select>

    <select id="findContractDetail" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ContractFormDTO">
        SELECT
              p.name AS name
            , cc.client_company_id AS clientCompanyId
            , cc.client_company_name AS clientCompanyName
            , cm.client_manager_id AS clientManagerId
            , cm.name AS clientManagerName
            , c.campaign_id AS campaignId
            , c.campaign_name AS campaignName
            , ps.pipeline_status_id AS pipelineStatusId
            , ps.status_name AS pipelineStatusName
            , p.request_at AS requestAt
            , p.presented_at AS presentAt
            , p.started_at AS startedAt
            , p.ended_at
            , p.notes AS notes
            , p.content AS content
            , p.expected_revenue AS expectedRevenue
            , p.available_quantity AS availableQuantity
            , p.expected_profit AS expectedProfit
            , c.product_price AS productPrice
        FROM
            pipeline p
        JOIN
            campaign c ON p.campaign_id = c.campaign_id
        JOIN
            pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id
        JOIN
            client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
            pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
            client_manager cm ON cm.client_manager_id = picm.client_manager_id

        WHERE
            p.is_deleted = 'N'
        AND
            p.pipeline_id = #{pipelineId}
        AND
            p.pipeline_step_id = #{pipelineStepId}
    </select>

    <select id="findRevenueDetail" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.RevenueFormDTO">
        SELECT
        p.name AS name
        , cc.client_company_id AS clientCompanyId
        , cc.client_company_name AS clientCompanyName
        , cm.client_manager_id AS clientManagerId
        , cm.name AS clientManagerName
        , c.campaign_id AS campaignId
        , c.campaign_name AS campaignName
        , ps.pipeline_status_id AS pipelineStatusId
        , ps.status_name AS pipelineStatusName
        , p.request_at AS requestAt
        , p.presented_at AS presentAt
        , p.started_at AS startedAt
        , p.ended_at
        , p.notes AS notes
        , p.content AS content
        , p.expected_revenue AS expectedRevenue
        , IFNULL(c.product_price, 0) AS productPrice
        , IFNULL(c.sales_quantity, 0) AS salesQuantity
        FROM
        pipeline p
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        JOIN
        pipeline_status ps ON p.pipeline_status_id = ps.pipeline_status_id
        JOIN
        client_company cc ON c.client_company_id = cc.client_company_id
        LEFT JOIN
        pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id AND picm.client_manager_id IS NOT NULL
        LEFT JOIN
        client_manager cm ON cm.client_manager_id = picm.client_manager_id

        WHERE
        p.is_deleted = 'N'
        AND
        p.pipeline_id = #{pipelineId}
        AND
        p.pipeline_step_id = #{pipelineStepId}
    </select>

    <select id="findPipelineInfluencer" resultMap="InfluencerInfoMap">
        SELECT
        i.influencer_id AS influencerId
        , i.name AS influencerName
        , y.name AS youtubeName
        , y.image_url AS youtubeThumbnailUrl
        , ins.name AS instagramName
        FROM
        influencer i
        JOIN
        pipeline_influencer_client_manager picm
        ON picm.influencer_id = i.influencer_id AND picm.influencer_id IS NOT NULL
        LEFT JOIN
        youtube y ON y.influencer_id = i.influencer_id
        LEFT JOIN
        instagram ins ON ins.influencer_id = i.influencer_id
        WHERE
        picm.pipeline_id = #{pipelineId}
    </select>

    <select id="findPipelineProposalInfluencer" resultType="be15fintomatokatchupbe.campaign.query.dto.response.InfluencerProposalInfo">
        SELECT
        i.influencer_id AS influencerId
        , i.name AS influencerName
        , picm.strength AS strength
        , picm.notes AS notes
        FROM
        influencer i
        JOIN
        pipeline_influencer_client_manager picm ON picm.influencer_id = i.influencer_id AND picm.influencer_id IS NOT NULL
        WHERE
        picm.pipeline_id = #{pipelineId}
    </select>

    <select id="findPipelineRevenueInfluencer" resultType="be15fintomatokatchupbe.campaign.query.dto.response.InfluencerRevenueInfo">
        SELECT
              i.influencer_id AS influencerId
            , i.name AS influencerName
            , picm.youtube_link AS youtubeLink
            , picm.instagram_link AS instagramLink
            , picm.ad_price AS adPrice
        FROM
            influencer i
        JOIN
            pipeline_influencer_client_manager picm ON picm.influencer_id = i.influencer_id AND picm.influencer_id IS NOT NULL
        WHERE
            picm.pipeline_id = #{pipelineId}
    </select>


    <select id="findPipelineUser" resultType="be15fintomatokatchupbe.campaign.query.dto.response.UserInfo">
        SELECT
              u.user_id AS userId
            , u.name AS userName
        FROM
            user u
        JOIN
            pipeline_user pu ON pu.user_id = u.user_id
        WHERE
            pu.pipeline_id = #{pipelineId}
    </select>


    <select id="findPipeReference" resultType="be15fintomatokatchupbe.campaign.query.dto.response.ReferenceInfo">
        SELECT
              p.pipeline_id AS pipelineId
            , p.name AS name
        FROM
            pipeline p
        WHERE
            p.is_deleted = 'N'
        AND
            p.pipeline_step_id = #{pipelineStepId}
<!--        AND-->
<!--            p.pipeline-->
    </select>

    <select id="findPipeIdea" resultType="be15fintomatokatchupbe.campaign.query.dto.response.IdeaInfo">
        SELECT
              i.idea_id AS ideaId
            , u.user_id AS userId
            , u.name AS userName
            , i.created_at AS createdAt
            , i.content AS content
        FROM
            idea i
        JOIN
            user u ON u.user_id = i.user_id
        WHERE
            i.pipeline_id = #{pipelineId}
        AND
            i.is_deleted = 'N'
        ORDER BY i.created_at desc, i.idea_id desc
    </select>

    <select id="findPipeFile" resultType="be15fintomatokatchupbe.campaign.query.dto.response.FileInfo">
        SELECT
              f.file_id AS fileId
            , f.file_name AS fileName
            , f.file_key AS fileKey
        FROM
            file f
        WHERE
            f.pipeline_id = #{pipelineId}
    </select>

    <!-- 캠페인 상세 정보 조회 -->
    <select id="selectCampaignDetail" resultType="be15fintomatokatchupbe.campaign.query.dto.response.CampaignDetailDto">
        SELECT
        c.campaign_id AS campaignId,
        c.campaign_name AS campaignName,
        c.campaign_status_id AS campaignStatusId,
        c.client_company_id AS clientCompanyId,
        cc.client_company_name AS clientCompanyName,
        cc.address,
        cc.detail_address,

        (
            SELECT cm.client_manager_id
            FROM pipeline p
            JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
            JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
            WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
                AND p.pipeline_step_id = 1
        ) AS clientManagerId,

        (
            SELECT cm.name
            FROM pipeline p
            JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
            JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
            WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
                AND p.pipeline_step_id = 1
        ) AS clientManagerName,

        c.awareness_path AS awarenessPath,
        c.product_name AS productName,
        c.product_price AS productPrice,

        (
            SELECT DATE_FORMAT(MIN(p.started_at), '%Y.%m.%d')
            FROM pipeline p
            WHERE p.campaign_id = c.campaign_id
            AND p.is_deleted = 'N'
        ) AS startedAt,
        (
            SELECT DATE_FORMAT(MAX(p.ended_at), '%Y.%m.%d')
            FROM pipeline p
            WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
        ) AS endedAt

        FROM campaign c
        LEFT JOIN client_company cc ON c.client_company_id = cc.client_company_id
        WHERE c.campaign_id = #{campaignId}
        AND c.is_deleted = 'N'
    </select>

    <!-- pipeline 테이블 기반 파생 정보들 -->
    <select id="selectTotalExpectedRevenue" resultType="long">
        SELECT IFNULL(p.expected_revenue, 0)
        FROM pipeline p
        WHERE p.campaign_id = #{campaignId}
        AND p.pipeline_step_id = 1
        AND p.is_deleted = 'N'
    </select>

    <select id="selectAverageExpectedProfitMargin" resultType="float">
        SELECT IFNULL(p.expected_profit_margin, 1)
        FROM pipeline p
        WHERE p.campaign_id = #{campaignId}
        AND p.pipeline_step_id = 1
        AND p.is_deleted = 'N'
    </select>

    <!-- 기회인지거 가져오기 -->
    <select id="selectCampaignNotes" resultType="string">
        SELECT p.notes
        FROM pipeline p
        WHERE p.campaign_id = #{campaignId}
        AND p.is_deleted = 'N'
        AND p.pipeline_step_id = 1
    </select>

    <!-- 캠페인 유저 리스트 조회 -->
    <select id="selectCampaignUserList" resultType="be15fintomatokatchupbe.user.command.domain.aggregate.User">
        SELECT
              u.user_id
            , u.name
        FROM campaign c
        JOIN pipeline p ON c.campaign_id = p.campaign_id
        JOIN user u ON u.user_id = p.writer_id
        WHERE c.campaign_id = #{campaignId}
          AND p.pipeline_step_id = 1
    </select>

    <!-- 캠페인 카테고리 리스트 조회 -->
    <select id="selectCampaignCategoryList" resultType="long">
        SELECT DISTINCT category_id
        FROM hashtag_influencer_campaign
        WHERE campaign_id = #{campaignId}
    </select>

    <!-- 캠페인 파이프라인 타임라인 조회 -->
    <select id="selectPipelineTimeline" resultType="be15fintomatokatchupbe.campaign.query.dto.response.PipelineTimelineDto">
        SELECT
        p.pipeline_id,
        p.pipeline_step_id,
        ps.step_name AS stepType,
        p.name AS pipelineTitle,
        cc.client_company_name AS clientCompanyName,
        (
        SELECT cm.name
        FROM pipeline_influencer_client_manager picm
        JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
        WHERE picm.pipeline_id = p.pipeline_id
        AND cm.is_deleted = 'N'
        ORDER BY cm.client_manager_id ASC
        LIMIT 1
        ) AS managerName,
        p.presented_at AS presentedAt,
        (
        SELECT COUNT(*)
        FROM pipeline_influencer_client_manager picm
        WHERE picm.pipeline_id = p.pipeline_id
        ) AS influencerCount,
        p.started_at,
        p.ended_at,
        DATE_FORMAT(p.created_at, '%Y-%m-%d') createdAt
        FROM pipeline p
        JOIN pipeline_step ps ON p.pipeline_step_id = ps.pipeline_step_id
        JOIN campaign c ON p.campaign_id = c.campaign_id
        JOIN client_company cc ON c.client_company_id = cc.client_company_id
        WHERE p.campaign_id = #{campaignId}
        AND p.is_deleted = 'N'
        ORDER BY p.presented_at ASC, p.pipeline_step_id DESC
    </select>

    <!-- 캠페인 목록 조회 -->
    <select id="findPagedCampaigns" resultType="be15fintomatokatchupbe.campaign.query.dto.response.CampaignListsDTO">
        SELECT
        c.campaign_id AS campaignId,
        c.campaign_name AS campaignName,
        c.campaign_status_id AS campaignStatusId,
        d.status_name AS campaignStatusName,
        cc.client_company_name AS clientCompanyName,
        (
        SELECT cm.name
        FROM pipeline p
        JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
        AND picm.influencer_id IS NULL
        JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
        WHERE p.campaign_id = c.campaign_id
        AND p.is_deleted = 'N'
        AND p.pipeline_step_id = 1
        ORDER BY cm.name LIMIT 1
        ) AS clientManagerName,
        (
        SELECT cm.position
        FROM pipeline p
        JOIN pipeline_influencer_client_manager picm
        ON p.pipeline_id = picm.pipeline_id
        AND picm.influencer_id IS NULL  <!-- 수정됨 -->
        JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
        WHERE p.campaign_id = c.campaign_id
        AND p.is_deleted = 'N'
        AND p.pipeline_step_id = 1
        ORDER BY cm.name
        LIMIT 1
        ) AS clientManagerPosition,
        (
        SELECT p.expected_revenue
        FROM pipeline p
        WHERE p.campaign_id = c.campaign_id
        AND p.pipeline_step_id = 1
        AND p.is_deleted = 'N'
        ) AS expectedRevenue,
        c.product_name AS productName,
        (
        SELECT DATE_FORMAT(MIN(p.started_at), '%Y.%m.%d')
        FROM pipeline p
        WHERE p.campaign_id = c.campaign_id
        AND p.is_deleted = 'N'
        ) AS startedAt,
        (
        SELECT DATE_FORMAT(MAX(p.ended_at), '%Y.%m.%d')
        FROM pipeline p
        WHERE p.campaign_id = c.campaign_id
        AND p.is_deleted = 'N'
        ) AS endedAt,

        (
        SELECT u.name
        FROM pipeline p_writer
        JOIN user u ON p_writer.writer_id = u.user_id
        WHERE p_writer.campaign_id = c.campaign_id
        AND p_writer.is_deleted = 'N'
        AND p_writer.pipeline_step_id = 1
        ORDER BY p_writer.created_at DESC
        LIMIT 1
        ) AS pipelineUserName,
        (
        SELECT u.position
        FROM pipeline p_writer
        JOIN user u ON p_writer.writer_id = u.user_id
        WHERE p_writer.campaign_id = c.campaign_id
        AND p_writer.is_deleted = 'N'
        AND p_writer.pipeline_step_id = 1
        ORDER BY p_writer.created_at DESC
        LIMIT 1
        ) AS pipelineUserPosition,
        (
        SELECT
        CEIL(
        CASE
        WHEN MAX(p.pipeline_step_id) > 7 THEN 7
        ELSE MAX(p.pipeline_step_id)
        END * 100.0 / 7
        )
        FROM pipeline p
        WHERE p.campaign_id = c.campaign_id
        AND p.pipeline_step_id != 8
        AND p.is_deleted = 'N'
        ) AS successProbability,
        (
        SELECT p.created_at
        FROM pipeline p
        WHERE p.campaign_id = c.campaign_id
        AND p.pipeline_step_id = 1
        AND p.is_deleted = 'N'
        ORDER BY p.created_at DESC
        LIMIT 1
        ) AS firstCreatedAt
        FROM campaign c
        JOIN campaign_status d ON d.campaign_status_id = c.campaign_status_id
        JOIN client_company cc ON c.client_company_id = cc.client_company_id
        <where>
            AND c.is_deleted = 'N'
            <if test="request.campaignStatus != null and request.campaignStatus != ''">
                AND c.campaign_status_id = #{request.campaignStatus}
            </if>

            <if test="request.expectedRevenueRange != null">
                AND EXISTS (
                SELECT 1
                FROM pipeline p
                WHERE p.campaign_id = c.campaign_id
                AND p.pipeline_step_id = 1
                AND p.is_deleted = 'N'
                <choose>
                    <when test="request.expectedRevenueRange == 1000000L">
                        AND p.expected_revenue &lt;= 1000000
                    </when>
                    <when test="request.expectedRevenueRange == 3000000L">
                        AND p.expected_revenue BETWEEN 1000001 AND 3000000
                    </when>
                    <when test="request.expectedRevenueRange == 5000000L">
                        AND p.expected_revenue BETWEEN 3000001 AND 5000000
                    </when>
                    <when test="request.expectedRevenueRange == 7000000L">
                        AND p.expected_revenue BETWEEN 5000001 AND 7000000
                    </when>
                    <when test="request.expectedRevenueRange == 10000000L">
                        AND p.expected_revenue BETWEEN 7000001 AND 10000000
                    </when>
                    <when test="request.expectedRevenueRange == 10000001L">
                        AND p.expected_revenue &gt;= 10000001
                    </when>
                </choose>
                )
            </if>

            <if test="request.startedDate != null">
                AND (
                SELECT MIN(p.started_at)
                FROM pipeline p
                WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
                ) &gt;= #{request.startedDate}
            </if>

            <if test="request.endedDate != null">
                AND (
                SELECT MAX(p.ended_at)
                FROM pipeline p
                WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
                ) &lt;= #{request.endedDate}
            </if>

            <if test="request.clientCompanyName != null and request.clientCompanyName != ''">
                AND cc.client_company_name LIKE CONCAT('%', #{request.clientCompanyName}, '%')
            </if>

            <if test="request.clientManagerName != null and request.clientManagerName != ''">
                AND EXISTS (
                SELECT 1
                FROM pipeline p
                JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
                AND picm.influencer_id IS NULL
                JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
                WHERE p.campaign_id = c.campaign_id
                AND p.pipeline_step_id = 1
                AND p.is_deleted = 'N'
                AND cm.name LIKE CONCAT('%', #{request.clientManagerName}, '%')
                )
            </if>

            <if test="request.stepType != null and request.stepType != ''">
                AND EXISTS (
                SELECT 1
                FROM pipeline pp
                WHERE pp.campaign_id = c.campaign_id
                AND pp.pipeline_step_id = (
                SELECT ps_inner.pipeline_step_id
                FROM pipeline_step ps_inner
                WHERE ps_inner.step_name = #{request.stepType}
                )
                AND pp.is_deleted = 'N'
                )
                AND NOT EXISTS (
                SELECT 1
                FROM pipeline pp2
                WHERE pp2.campaign_id = c.campaign_id
                AND pp2.pipeline_step_id > (
                SELECT ps_inner.pipeline_step_id
                FROM pipeline_step ps_inner
                WHERE ps_inner.step_name = #{request.stepType}
                )
                AND pp2.is_deleted = 'N'
                )
            </if>

            <if test="request.campaignName != null and request.campaignName != ''">
                AND c.campaign_name LIKE CONCAT('%', #{request.campaignName}, '%')
            </if>

            <if test="request.productName != null and request.productName != ''">
                AND c.product_name LIKE CONCAT('%', #{request.productName}, '%')
            </if>
        </where>
        ORDER BY firstCreatedAt DESC, c.campaign_id DESC
        LIMIT #{limit}
        OFFSET #{offset}
    </select>

    <!-- 파이프라인 개수 세기-->
    <select id="getTotalSize" resultType="Integer">
        SELECT COUNT(*)
        FROM campaign c
        JOIN campaign_status d ON d.campaign_status_id = c.campaign_status_id
        JOIN client_company cc ON c.client_company_id = cc.client_company_id
        JOIN client_company_user ccu ON ccu.client_company_id = c.client_company_id
        JOIN user u ON u.user_id = ccu.user_id
        <where>
            AND c.is_deleted = 'N'

            <if test="request.campaignStatus != null and request.campaignStatus != ''">
                AND c.campaign_status_id = #{request.campaignStatus}
            </if>

            <if test="request.expectedRevenueRange != null">
                AND EXISTS (
                SELECT 1
                FROM pipeline p
                WHERE p.campaign_id = c.campaign_id
                AND p.pipeline_step_id = 1
                AND p.is_deleted = 'N'
                <choose>
                    <when test="request.expectedRevenueRange == 1000000">
                        AND p.expected_revenue &lt;= 1000000
                    </when>
                    <when test="request.expectedRevenueRange == 3000000">
                        AND p.expected_revenue BETWEEN 1000001 AND 3000000
                    </when>
                    <when test="request.expectedRevenueRange == 5000000">
                        AND p.expected_revenue BETWEEN 3000001 AND 5000000
                    </when>
                    <when test="request.expectedRevenueRange == 7000000">
                        AND p.expected_revenue BETWEEN 5000001 AND 7000000
                    </when>
                    <when test="request.expectedRevenueRange == 10000000">
                        AND p.expected_revenue BETWEEN 7000001 AND 10000000
                    </when>
                    <when test="request.expectedRevenueRange == 10000001">
                        AND p.expected_revenue &gt;= 10000001
                    </when>
                </choose>
                )
            </if>

            <if test="request.startedDate != null">
                AND (
                SELECT MIN(p.started_at)
                FROM pipeline p
                WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
                ) &gt;= #{request.startedDate}
            </if>

            <if test="request.endedDate != null">
                AND (
                SELECT MAX(p.ended_at)
                FROM pipeline p
                WHERE p.campaign_id = c.campaign_id
                AND p.is_deleted = 'N'
                ) &lt;= #{request.endedDate}
            </if>

            <if test="request.clientCompanyName != null and request.clientCompanyName != ''">
                AND cc.client_company_name LIKE CONCAT('%', #{request.clientCompanyName}, '%')
            </if>

            <if test="request.clientManagerName != null and request.clientManagerName != ''">
                AND EXISTS (
                SELECT 1
                FROM pipeline p
                JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
                JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
                WHERE p.campaign_id = c.campaign_id
                AND p.pipeline_step_id = 1
                AND p.is_deleted = 'N'
                AND cm.name LIKE CONCAT('%', #{request.clientManagerName}, '%')
                )
            </if>

            <if test="request.stepType != null and request.stepType != ''">
                AND EXISTS (
                SELECT 1
                FROM pipeline pp
                WHERE pp.campaign_id = c.campaign_id
                AND pp.pipeline_step_id = (
                SELECT ps_inner.pipeline_step_id
                FROM pipeline_step ps_inner
                WHERE ps_inner.step_name = #{request.stepType}
                )
                AND pp.is_deleted = 'N'
                )
                AND NOT EXISTS (
                SELECT 1
                FROM pipeline pp2
                WHERE pp2.campaign_id = c.campaign_id
                AND pp2.pipeline_step_id > (
                SELECT ps_inner.pipeline_step_id
                FROM pipeline_step ps_inner
                WHERE ps_inner.step_name = #{request.stepType}
                )
                AND pp2.is_deleted = 'N'
                )
            </if>

            <if test="request.campaignName != null and request.campaignName != ''">
                AND c.campaign_name LIKE CONCAT('%', #{request.campaignName}, '%')
            </if>

            <if test="request.productName != null and request.productName != ''">
                AND c.product_name LIKE CONCAT('%', #{request.productName}, '%')
            </if>
        </where>
    </select>

    <!-- pipelineSteps 가져오기 -->
    <select id="findPipelineStepsByCampaignIds" resultType="be15fintomatokatchupbe.campaign.query.dto.response.PipelineStepStatusDto">
        SELECT
        p.campaign_id,
        ps.step_name AS stepType,
        DATE_FORMAT(p.created_At, '%Y-%m-%d') AS createdAt
        FROM pipeline p
        JOIN pipeline_step ps ON p.pipeline_step_id = ps.pipeline_step_id
        WHERE p.campaign_id IN
        <foreach item="id" collection="campaignIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>


    <select id="findCampaignList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.CampaignSimpleDto">
        SELECT
              campaign_id AS id
            , campaign_name AS name
        FROM
            campaign
        <where>
            is_deleted = 'N'
            AND
                campaign_status_id IN (2, 3, 4)
            <if test="clientCompanyId != null">
                AND client_company_id = #{clientCompanyId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND campaign_name LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>

    </select>
    <select id="getReferenceList" resultType="be15fintomatokatchupbe.campaign.query.dto.mapper.ReferenceDto">
        SELECT
              p.pipeline_id AS pipelineId
            , p.name AS name
        FROM
            pipeline p
        JOIN campaign c ON c.campaign_id = p.campaign_id
        <where>
                p.pipeline_step_id = #{pipelineStepId}
            AND
                p.is_deleted = 'N'
            AND
                c.campaign_status_id IN (2, 3, 4)
            <if test="pipelineStepId != 2">
                AND p.pipeline_status_id = 2
            </if>
            <if test="campaignId != null">
                AND p.campaign_id = #{campaignId}
            </if>
        </where>
    </select>

    <select id="findCampaignResultList" resultType="be15fintomatokatchupbe.campaign.query.dto.response.CampaignResultResponse">
        SELECT
            p.pipeline_id AS pipelineId,
            c.campaign_name AS name,
            c.product_name AS productName,
            c.updated_at AS registrationDate,
            cm.name AS clientName,
            cc.client_company_name AS clientCompanyName
        FROM campaign c
        LEFT JOIN campaign_status cs ON c.campaign_status_id = cs.campaign_status_id
        LEFT JOIN pipeline p ON c.campaign_id = p.campaign_id
        LEFT JOIN pipeline_step ps ON p.pipeline_step_id = ps.pipeline_step_id
        LEFT JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
        LEFT JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
        LEFT JOIN client_company cc ON cm.client_company_id = cc.client_company_id
        WHERE picm.client_manager_id IS NOT NULL
        AND cs.campaign_status_id = 5
        AND ps.pipeline_step_id = 7
        <if test="request.name != null and request.name != ''">
            AND c.campaign_name LIKE CONCAT('%', #{request.name}, '%')
        </if>
        ORDER BY p.pipeline_id DESC
    </select>

    <select id="findInfluencerInfoByPipelineIds" resultType="be15fintomatokatchupbe.campaign.query.dto.response.CampaignInfluencerInfo">
        SELECT
            picm.pipeline_id AS pipelineId,
            picm.pipeline_influencer_id AS pipelineInfluencerId,
            i.influencer_id AS influencerId,
            i.name AS influencerName
        FROM pipeline_influencer_client_manager picm
        LEFT JOIN influencer i ON picm.influencer_id = i.influencer_id
        WHERE picm.influencer_id IS NOT NULL
        AND picm.pipeline_id IN
        <foreach item="id" collection="pipelineIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="countCampaignResultList" resultType="int">
        SELECT COUNT(*)
        FROM campaign c
        LEFT JOIN campaign_status cs ON c.campaign_status_id = cs.campaign_status_id
        LEFT JOIN pipeline p ON c.campaign_id = p.campaign_id
        LEFT JOIN pipeline_step ps ON p.pipeline_step_id = ps.pipeline_step_id
        LEFT JOIN pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
        LEFT JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
        LEFT JOIN client_company cc ON cm.client_company_id = cc.client_company_id
        WHERE
        picm.client_manager_id IS NOT NULL
        AND cs.campaign_status_id = 5
        AND ps.pipeline_step_id = 7
        <if test="request.name != null and request.name != ''">
            AND c.campaign_name LIKE CONCAT('%', #{request.name}, '%')
        </if>
    </select>

    <!-- 고객사 별 캠페인 목록 조회 -->
    <select id="findCampaignsByClientCompanyId" resultType="be15fintomatokatchupbe.campaign.query.dto.response.CampaignListDTO">
        SELECT
        c.campaign_id AS campaignId,
        c.campaign_name AS campaignName,
        cs.campaign_status_id AS campaignStatusId,
        cs.status_name AS campaignStatusName,
        cc.client_company_id AS clientCompanyId,
        cc.client_company_name AS clientCompanyName,
        cm.name AS clientManagerName,
        cm.position AS clientManagerPosition,
        c.product_name AS productName,
        (
        SELECT p.expected_revenue
        FROM pipeline p
        WHERE p.campaign_id = c.campaign_id
        AND p.pipeline_step_id = 1
        AND p.is_deleted = 'N'
        ) AS expectedRevenue,
        DATE_FORMAT(p.started_at, '%Y-%m-%d') AS startedAt,
        DATE_FORMAT(p.ended_at, '%Y-%m-%d') AS endedAt,
        u.name AS pipelineUserName,
        u.position AS pipelineUserPosition
        FROM campaign c
        JOIN campaign_status cs ON c.campaign_status_id = cs.campaign_status_id
        JOIN client_company cc ON c.client_company_id = cc.client_company_id
        JOIN client_manager cm ON cm.client_company_id = cc.client_company_id AND cm.is_deleted = 'N'
        JOIN pipeline p ON p.campaign_id = c.campaign_id
        JOIN pipeline_user pu ON pu.pipeline_id = p.pipeline_id
        JOIN user u ON pu.user_id = u.user_id AND u.is_deleted = 'N'
        WHERE c.client_company_id = #{clientCompanyId}
        GROUP BY c.campaign_id
        ORDER BY p.started_at DESC
    </select>

    <!-- pipelineSteps 가져오기 -->
    <select id="findPipelineStepsGroupedByCampaignIds" resultType="be15fintomatokatchupbe.campaign.query.dto.response.PipelineStepsDto">
        SELECT
            p.campaign_id AS campaignId,
            p.pipeline_status_id,
            ps.step_name AS stepType,
            DATE_FORMAT(p.created_at, '%Y-%m-%d') AS createdAt
          FROM pipeline p
          JOIN pipeline_step ps ON p.pipeline_step_id = ps.pipeline_step_id
         WHERE p.campaign_id IN
        <foreach item="id" collection="campaignIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND p.is_deleted = 'N'
    </select>

    <select id="findCampaignByInfluencerId" resultType="be15fintomatokatchupbe.influencer.query.dto.response.CampaignRecord">
        SELECT
            p.pipeline_id
            , c.campaign_name
        FROM
            pipeline p
        JOIN
            campaign c ON c.campaign_id = p.campaign_id
        JOIN
            pipeline_influencer_client_manager picm ON p.pipeline_id = picm.pipeline_id
        WHERE
            picm.influencer_id = #{id}
        AND
            p.pipeline_step_id = 7
        AND
            c.campaign_status_id = 5
    </select>

    <!-- 고객사의 커뮤니케이션 이력 -->
    <resultMap id="communicationHistoryResultMap" type="be15fintomatokatchupbe.campaign.query.dto.response.CommunicationHistoryResponse">
        <id property="id" column="pipeline_id"/>
        <result property="campaignId" column="campaign_id"/>
        <result property="campaignName" column="campaign_name"/>

        <result property="pipelineStepName" column="step_name"/>
        <result property="pipelineTitle" column="pipeline_title"/>
        <result property="pipelineCreatedAt" column="pipeline_created_at"/>

        <result property="managerName" column="manager_name"/>
        <result property="managerDepartment" column="manager_department"/>

        <result property="content" column="pipeline_content"/>
        <result property="notes" column="pipeline_notes"/>
        <result property="fileName" column="file_name"/> </resultMap>

    <select id="findCommunicationHistoriesByClientCompanyId" resultMap="communicationHistoryResultMap">
        SELECT
        p.pipeline_id,
        p.campaign_id,
        c.campaign_name,
        ps.step_name,
        p.name AS pipeline_title,
        DATE(p.created_at) AS pipeline_created_at,

        cm.name AS manager_name,
        cm.department AS manager_department,
        p.content AS pipeline_content,
        p.notes AS pipeline_notes,
        f.file_name AS file_name
        FROM
        pipeline p
        JOIN
        pipeline_step ps ON p.pipeline_step_id = ps.pipeline_step_id
        JOIN
        campaign c ON p.campaign_id = c.campaign_id
        LEFT JOIN (
        SELECT *
        FROM (
        SELECT picm.pipeline_id, cm.name, cm.department,
        ROW_NUMBER() OVER (PARTITION BY picm.pipeline_id ORDER BY cm.created_at DESC) AS rn
        FROM pipeline_influencer_client_manager picm
        JOIN client_manager cm ON picm.client_manager_id = cm.client_manager_id
        WHERE cm.is_deleted = 'N'
        ) sub
        WHERE sub.rn = 1
        ) cm ON p.pipeline_id = cm.pipeline_id

        LEFT JOIN
        file f ON p.pipeline_id = f.pipeline_id

        WHERE
        c.client_company_id = #{clientCompanyId}
        AND p.is_deleted = 'N'

        ORDER BY
        p.created_at DESC
    </select>

    <resultMap id="RequestCampaignMap" type="be15fintomatokatchupbe.campaign.query.dto.mapper.RequestCampaign">
        <id property="campaignId" column="campaign_id"/>
        <result property="productName" column="product_name"/>
        <collection property="categoryList" ofType="int" column="category_id"/>
    </resultMap>

    <select id="findProductNameByCampaignId" resultMap="RequestCampaignMap">
        SELECT
        c.campaign_id,
        c.product_name,
        hic.category_id
        FROM
        campaign c
        JOIN
        hashtag_influencer_campaign hic ON c.campaign_id = hic.campaign_id
        WHERE
        c.campaign_id = #{campaignId}
    </select>

    <!-- 인플루언서 필터링 -->
    <select id="findInfluencerAndProduct" resultType="int">
        SELECT
              i.influencer_id
        FROM
            influencer i
        JOIN
            youtube_stats_snapshot yss ON i.influencer_id = yss.influencer_id
        JOIN
            youtube y ON y.influencer_id = i.influencer_id
        WHERE
            i.is_deleted = 'N'
        <!-- 언령대 -->
        <choose>

            <when test="request.preferredAgeRange == '1317'">
                AND yss.age1317 >= yss.age1824
                AND yss.age1317 >= yss.age2534
                AND yss.age1317 >= yss.age3544
                AND yss.age1317 >= yss.age4554
                AND yss.age1317 >= yss.age5564
                AND yss.age1317 >= yss.age65plus
            </when>
            <when test="request.preferredAgeRange == '1824'">
                AND yss.age1824 >= yss.age1317
                AND yss.age1824 >= yss.age2534
                AND yss.age1824 >= yss.age3544
                AND yss.age1824 >= yss.age4554
                AND yss.age1824 >= yss.age5564
                AND yss.age1824 >= yss.age65plus
            </when>
            <when test="request.preferredAgeRange == '2534'">
                AND yss.age2534 >= yss.age1317
                AND yss.age2534 >= yss.age1824
                AND yss.age2534 >= yss.age3544
                AND yss.age2534 >= yss.age4554
                AND yss.age2534 >= yss.age5564
                AND yss.age2534 >= yss.age65plus
            </when>
            <when test="request.preferredAgeRange == '3544'">
                AND yss.age3544 >= yss.age1317
                AND yss.age3544 >= yss.age1824
                AND yss.age3544 >= yss.age2534
                AND yss.age3544 >= yss.age4554
                AND yss.age3544 >= yss.age5564
                AND yss.age3544 >= yss.age65plus
            </when>
            <when test="request.preferredAgeRange == '4554'">
                AND yss.age4554 >= yss.age1317
                AND yss.age4554 >= yss.age1824
                AND yss.age4554 >= yss.age2534
                AND yss.age4554 >= yss.age3544
                AND yss.age4554 >= yss.age5564
                AND yss.age4554 >= yss.age65plus
            </when>
            <when test="request.preferredAgeRange == '5564'">
                AND yss.age5564 >= yss.age1317
                AND yss.age5564 >= yss.age1824
                AND yss.age5564 >= yss.age2534
                AND yss.age5564 >= yss.age3544
                AND yss.age5564 >= yss.age4554
                AND yss.age5564 >= yss.age65plus
            </when>
            <when test="request.preferredAgeRange == '65'">
                AND yss.age65plus >= yss.age1317
                AND yss.age65plus >= yss.age1824
                AND yss.age65plus >= yss.age2534
                AND yss.age65plus >= yss.age3544
                AND yss.age65plus >= yss.age4554
                AND yss.age65plus >= yss.age5564
            </when>
        </choose>
        <!-- 성별 -->
        <choose>
            <when test="request.preferredGender == 2">
                AND yss.gender_female >= yss.gender_male
            </when>
            <when test="request.preferredGender == 1">
                AND yss.gender_male > yss.gender_female
            </when>
        </choose>
        <!-- 만족도 조사 -->
        <if test="request.advertiserSatisfaction != null and request.advertiserSatisfaction > 0">
            AND (
            SELECT IFNULL(ROUND(AVG(score), 1), 0.0)
            FROM satisfaction s
            WHERE s.influencer_id = i.influencer_id
            AND s.score IS NOT NULL
            ) >= #{request.advertiserSatisfaction}
        </if>
        <!-- 알고리즘 스코어 -->
        <if test="request.algorithmScore != null and request.algorithmScore > 0">
            AND LEAST(
            (IF(y.subscriber IS NULL OR y.subscriber = 0, 0, (yss.avg_views / y.subscriber)) * 100),
            100
            ) >= #{request.algorithmScore}
        </if>
        <!-- 참여도 -->
        <if test="request.engagement != null and request.engagement > 0">
            AND LEAST(
            IF(yss.avg_views IS NULL OR yss.avg_views = 0, 0,
            ((yss.avg_likes + yss.avg_comments) / yss.avg_views) * 100
            ),
            100
            ) >= #{request.engagement}
        </if>
        <!-- 구독자 수 -->
        <if test="request.followerCount != null and request.followerCount > 0">
            AND y.subscriber >= #{request.followerCount}
        </if>
        <!-- 카테고리-->
        <if test="request.categories != null and request.categories != false and categoryList != null and categoryList.size() > 0">
            AND EXISTS (
            SELECT 1
            FROM hashtag_influencer_campaign hic
            WHERE hic.influencer_id = i.influencer_id
            AND hic.category_id IN
            <foreach item="category" collection="categoryList" open="(" separator="," close=")">
                #{category}
            </foreach>
            )
        </if>
    </select>

    <select id="findProductByInfluencerId" resultType="string">
        SELECT
            product_name
        FROM
            campaign c
        JOIN
            pipeline p ON c.campaign_id = p.campaign_id
        JOIN
            pipeline_influencer_client_manager picm ON picm.pipeline_id = p.pipeline_id
        WHERE
            p.pipeline_step_id = 7
        AND
            p.pipeline_status_id = 2
        AND
            c.campaign_status_id = 5
        AND
            picm.influencer_id = #{influencerId}
    </select>
</mapper>
